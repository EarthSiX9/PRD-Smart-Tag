<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PRD Smart-TAG — Production vs Customer</title>
  <meta name="x-build" content="2025-09-02 r40-scan-confirm-chain-auto + fixlist">
  <style>
    :root{
      --bg:#f7f9fc; --card:#ffffff; --text:#1f2a44; --muted:#6b7280;
      --line:#e5e7eb; --accent:#2563eb; --accent-weak:#eef2ff;
      --ok:#0f7a3a; --ok-bg:#e8f7ee; --ng:#b91c1c; --ng-bg:#fde8e8;
      --btnborder:#d1d5db; --toast:#111827; --toast-text:#f9fafb;
      --focus-bg:#fff7cc; --prd:#d60000; --smart:#042157;
      --side-bg:#ffffff; --side-text:#1f2937; --side-hover:#f3f4f6;
      --topbar-bg:#ffffff; --fixed:#fef9c3;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;color:var(--text)}

    /* Topbar */
    .topbar{position:sticky; top:0; z-index:1000; display:flex; align-items:center; gap:12px;
      padding:10px 14px; background:var(--topbar-bg); border-bottom:1px solid var(--line);}
    .menu-btn{display:inline-flex; align-items:center; justify-content:center; width:40px; height:40px;
      border-radius:10px; border:1px solid var(--line); background:#fff; cursor:pointer; font-size:18px;}
    .menu-btn:active{ transform:translateY(1px); }
    .brand-inline{display:flex; align-items:baseline; gap:10px; line-height:1; user-select:none;}
    .brand-prd{font-family:"LilyUPC","Tahoma","Noto Sans Thai",sans-serif;font-weight:800;font-style:italic;color:var(--prd);font-size:32px;letter-spacing:.5px}
    .brand-smart{font-family:"LilyUPC","Tahoma","Noto Sans Thai",sans-serif;font-weight:800;color:var(--smart);font-size:28px;letter-spacing:.3px}
    .spacer{flex:1}
    .topbar-right{display:flex; align-items:center; gap:10px}
    .badge{display:inline-block;padding:6px 10px;border-radius:999px;border:1px solid var(--line);background:#fff;font-size:12px}

    /* Layout + sidebar */
    .layout{display:grid; grid-template-columns: 260px 1fr; min-height:calc(100vh - 62px); transition:grid-template-columns .2s ease}
    .layout.collapsed{grid-template-columns: 0 1fr;}
    .side{background:var(--side-bg); color:var(--side-text); padding:18px 14px; position:sticky; top:62px; height:calc(100vh - 62px);
      border-right:1px solid var(--line); display:flex; flex-direction:column; gap:14px; transition:transform .2s ease, opacity .2s ease;}
    .layout.collapsed .side{ transform:translateX(-100%); opacity:0; pointer-events:none; }

    .nav{display:flex; flex-direction:column; gap:6px; margin-top:10px}
    .nav button{ text-align:left; width:100%; padding:10px 12px; border-radius:10px; border:1px solid transparent;
      background:transparent; color:var(--side-text); cursor:pointer; font-size:14px;}
    .nav button:hover{ background:var(--side-hover); }
    .nav button.active{ background:var(--accent-weak); border-color:#dbeafe; }

    .parent{display:flex; align-items:center; justify-content:space-between; padding:10px 12px; border-radius:10px; cursor:pointer}
    .parent:hover{ background:var(--side-hover); }
    .caret{font-size:12px; opacity:.8; transition:transform .2s}
    .parent.expanded .caret{ transform:rotate(90deg); }
    .submenu{display:none; flex-direction:column; gap:6px; padding-left:10px; margin-top:2px;}
    .submenu.show{display:flex;}
    .submenu button{ padding:8px 12px; font-size:13px; border-radius:10px; }

    /* Main area */
    .wrap{max-width:100%;margin:0 auto;padding:24px}

    .howto{border:1px solid #f1d36a;background:var(--focus-bg);border-radius:14px;padding:14px;display:flex;align-items:center;justify-content:center;margin:12px 0 18px}
    .howto .focus-msg{font-weight:900;color:#111;text-align:center;white-space:pre-line}

    .cmp-top-grid{width:100%;display:grid;grid-template-columns:1fr 1fr;gap:16px;align-items:start}
    .cmp-bottom{margin-top:16px}
    .card{border:1px solid var(--line);background:var(--card);border-radius:14px;padding:16px;box-shadow:0 1px 2px rgba(0,0,0,.04),0 8px 24px rgba(0,0,0,.03)}
    .card h3{margin:0 0 8px;font-size:16px}
    .card.compact{padding:10px}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .muted{color:#6b7280}

    input[type=text], input[type=date], input[type=password]{flex:1;min-width:220px;padding:10px 12px;border-radius:10px;border:1px solid var(--btnborder);background:#fff;color:#2b364d;outline:none}
    input::placeholder{color:#9ca3af}
    input[readonly]{background:#f3f4f6}
    button{padding:10px 14px;border-radius:12px;border:1px solid var(--btnborder);background:#fff;color:#1f2a44;cursor:pointer}
    button.primary{background:var(--accent);color:#fff;border-color:transparent}
    button[disabled]{opacity:.5;cursor:not-allowed}
    .icon-btn{display:inline-flex;align-items:center;gap:6px;padding:8px 10px;border-radius:10px;border:1px solid var(--btnborder);background:#fff}
    .icon-btn.small{padding:6px 8px;font-size:12px}
    .icon-btn:active{transform:translateY(1px)}

    .result-banner{display:none;align-items:center;justify-content:center;border-radius:14px;padding:18px;font-weight:900;letter-spacing:.5px;text-align:center;margin-bottom:10px;font-size:60px}
    .banner-ok{background:var(--ok-bg);color:var(--ok);border:1px solid #86efac}
    .banner-ng{background:var(--ng-bg);color:#b91c1c;border:1px solid #fca5a5}

    .cmp{width:100%; border-collapse:collapse; margin-top:10px; font-size:13px}
    .cmp th,.cmp td{padding:10px 12px; border:1px solid var(--line)}
    .cmp th{background:#f8fafc; color:#475569; text-align:left}
    .ok-row{ background:var(--ok-bg) !important; color:var(--ok) !important; font-weight:800; }
    .ng-row{ background:var(--ng-bg) !important; color:#b91c1c !important; font-weight:800; }
    .fix-row{ background:var(--fixed) !important; }

    /* totals summary */
    #log-totals{display:flex;gap:14px;align-items:center;font-size:13px;padding:8px 10px;background:#f8fafc;border:1px solid var(--line);border-radius:10px;margin-bottom:8px}
    #log-totals .dot{width:8px;height:8px;border-radius:999px;display:inline-block;margin-right:6px;background:#9ca3af}
    #log-totals .ok .dot{background:var(--ok)}
    #log-totals .ng .dot{background:#b91c1c}
    #log-totals b{font-size:14px}

    .toast{position:fixed;right:18px;top:72px;z-index:9500;background:#111827;color:#f9fafb;border:1px solid #374151;border-radius:12px;padding:10px 14px;box-shadow:0 10px 28px rgba(0,0,0,.25);opacity:0;transform:translateY(-8px);pointer-events:none;transition:opacity .18s,transform .18s;max-width:80vw}
    .toast.show{opacity:1;transform:translateY(0)}

    .logs{border:1px solid var(--line);border-radius:12px;background:#fff;overflow:auto;max-height:420px}
    table{width:100%;border-collapse:collapse;font-size:12px}
    th,td{padding:8px 10px;border-bottom:1px solid var(--line);white-space:nowrap}
    th{position:sticky;top:0;background:#f8fafc;text-align:left;color:#475569}

    /* Login overlay */
    .login-screen{position:fixed; inset:0; z-index:10000; background:#0b1220; display:flex; align-items:center; justify-content:center;}
    .login-panel{width:min(92vw,560px); background:#ffffff; border-radius:18px; border:1px solid #e5e7eb; box-shadow:0 30px 100px rgba(0,0,0,.45); overflow:hidden;}
    .login-panel header{background:#f8fafc; border-bottom:1px solid #e5e7eb; padding:16px 18px; font-weight:800;}
    .login-panel .body{ padding:16px 18px; }
    .login-panel .foot{ padding:12px 18px; border-top:1px solid #e5e7eb; display:flex; gap:8px; justify-content:flex-end }
    .mutewarn{background:#fffbeb;color:#b45309;border:1px solid #fcd34d;padding:8px 10px;border-radius:10px;font-size:12px}
    #login-cam{display:none}
    #login-cam.mirror video{ transform: scaleX(-1) !important; }
    #login-last{font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size:12px}

    /* QR overlay */
    .qr-overlay{position:fixed; inset:0; z-index:9800; background:rgba(0,0,0,.6); display:none; align-items:center; justify-content:center; padding:16px}
    .qr-panel{width:min(92vw,520px); background:#fff; border-radius:16px; border:1px solid var(--line); box-shadow:0 24px 80px rgba(0,0,0,.4); overflow:hidden}
    .qr-panel header{padding:12px 14px; border-bottom:1px solid var(--line); background:#f8fafc; font-weight:800}
    .qr-body{padding:12px 14px}
    .qr-foot{padding:12px 14px; border-top:1px solid var(--line); display:flex; gap:8px; align-items:center; flex-wrap:wrap}
    #qr-region{width:100%; min-height:320px}
    #qr-last{font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size:12px; color:#374151}

    @media (max-width: 960px){
      .layout{grid-template-columns: 0 1fr;}
      .side{transform:translateX(-100%); opacity:0; pointer-events:none;}
      .wrap{padding-left:16px; padding-right:16px;}
      .cmp-top-grid{ grid-template-columns: 1fr; }
    }
  </style>
  <script src="https://unpkg.com/html5-qrcode"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
</head>
<body>
  <!-- Topbar -->
  <div class="topbar">
    <button id="btn-menu" class="menu-btn" aria-label="สลับเมนู">☰</button>
    <div class="brand-inline">
      <div class="brand-prd">PRD</div>
      <div class="brand-smart">Smart-TAG</div>
    </div>
    <div class="spacer"></div>
    <div class="topbar-right">
      <span id="user-pill" class="badge" style="display:none"></span>
      <button id="btn-logout" onclick="logout()" style="display:none">ออกจากระบบ</button>
    </div>
  </div>

  <!-- Layout -->
  <div id="app-layout" class="layout">
    <!-- Sidebar -->
    <aside class="side" id="sidebar">
      <nav class="nav">
        <div id="parent-checker" class="parent" onclick="toggleSubmenu('checker')">
          <span>Tag Match Checker</span><span class="caret">▶</span>
        </div>
        <div id="submenu-checker" class="submenu show">
          <button id="nav-checker" onclick="switchView('checker')" class="active">Tag Check</button>
          <button id="nav-fix" onclick="switchView('fix')">แก้ไขงาน NG</button>
          <button id="nav-logs" onclick="switchView('logs')">Scan Logs</button>
        </div>
        <button id="nav-print" onclick="switchView('print')">Print Tag</button>
        <button id="nav-create" onclick="switchView('create')">Create Tag</button>
      </nav>
      <div style="margin-top:auto; font-size:12px; opacity:.7">© Paradise Plastic</div>
    </aside>

    <!-- Tag Check -->
    <main id="view-checker" class="wrap" aria-hidden="true">
      <div class="howto">
        <div id="focus-msg" class="focus-msg"></div>
      </div>

      <div class="card" id="fix-banner" style="display:none;margin-bottom:12px">
        <div class="row" style="justify-content:space-between">
          <div><b>โหมดแก้ไขงาน NG</b> — อ้างอิง: <span id="fix-ref"></span></div>
          <div><button class="icon-btn small" onclick="cancelFixMode()">ยกเลิก</button></div>
        </div>
      </div>

      <div class="cmp-top-grid">
        <div class="card">
          <h3>แท็กผลิต (Production Tag)</h3>
          <div class="row">
            <input id="in-prod" type="text" placeholder="กำลังรอการสแกน Qr-code ที่แท็กฝ่ายผลิต" readonly />
            <button class="icon-btn small" onclick="openScanner('prod', {chainNext:true})" title="เปิดกล้องสแกน"><span>📷</span> สแกน</button>
          </div>
        </div>

        <div class="card">
          <h3>แท็กลูกค้า (Customer Tag)</h3>
          <div class="row">
            <input id="in-cust" type="text" placeholder="กำลังรอการสแกน Qr-code ที่แท็กลูกค้า" readonly />
            <button class="icon-btn small" onclick="openScanner('cust')" title="เปิดกล้องสแกน"><span>📷</span> สแกน</button>
          </div>
        </div>
      </div>

      <div class="cmp-bottom">
        <div class="card result-card">
          <h3>ผลการตรวจสอบ</h3>
          <div id="banner" class="result-banner"></div>
          <table class="cmp" id="cmp-table" aria-label="รายละเอียดผลการตรวจสอบ">
            <thead><tr><th>หัวข้อ</th><th>ผลิต</th><th>ลูกค้า</th></tr></thead>
            <tbody>
              <tr id="cmp-pn"><td>Part Number</td><td id="cmp-pn-prod">—</td><td id="cmp-pn-cust">—</td></tr>
              <tr id="cmp-name"><td>Part Name</td><td id="cmp-name-prod">—</td><td id="cmp-name-cust">—</td></tr>
              <tr id="cmp-qty"><td>Qty.</td><td id="cmp-qty-prod">—</td><td id="cmp-qty-cust">—</td></tr>
              <tr id="cmp-mat"><td>Material</td><td id="cmp-mat-prod">—</td><td id="cmp-mat-cust">—</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </main>

    <!-- Fix NG view -->
    <main id="view-fix" class="wrap" style="display:none">
      <h2>รายการงาน NG ที่ต้องแก้ไข <span class="muted">|</span>
        <span class="muted">ยังไม่แก้ไข: <b id="fix-todo">0</b> แก้ไขแล้ว: <b id="fix-done">0</b></span>
      </h2>

      <div class="card">
        <div class="logs" style="margin-top:10px">
          <table id="fix-table">
            <thead>
              <tr>
                <th>เวลา/วันที่</th><th>รหัสพนักงาน</th><th>Material</th><th>Prod PN</th><th>Part Name</th><th>Qty</th><th>Cust PN</th><th>Cust Qty</th><th>ดำเนินการ</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </main>

    <!-- Logs -->
    <main id="view-logs" class="wrap" style="display:none">
      <h2>Scan Logs</h2>

      <div class="card">
        <div class="row" style="gap:12px; align-items:flex-end">
          <div class="muted"></div>
          <div style="margin-left:auto; display:flex; gap:8px; align-items:center">
            <label>กรอกรหัสผ่านเพื่อลบข้อมูล</label>
            <input id="admin-pass" type="password" placeholder="Password">
            <button onclick="handleClearLogs()" style="background:#b91c1c;color:#fff;border-color:#b91c1c">ล้าง Logs ทั้งหมด</button>
            <button onclick="exportFilteredLogs()">ดาวน์โหลดข้อมูล (ตามตัวกรอง)</button>
          </div>
        </div>
      </div>

      <div class="card compact">
        <h3>ตัวกรอง</h3>
        <div class="filters">
          <input type="date" id="flt-start"> <span>—</span> <input type="date" id="flt-end">
          <button onclick="applyFilters()">กรอง</button>
          <button onclick="clearFilters()">ล้าง</button>
        </div>
      </div>

      <div class="card">
        <h3>รายการสแกน</h3>

        <div id="log-totals" aria-live="polite">
          <span class="all">รวมทั้งหมด: <b id="sum-total">0</b></span>
          <span class="ok"><span class="dot"></span>OK: <b id="sum-ok">0</b></span>
          <span class="ng"><span class="dot"></span>NG: <b id="sum-ng">0</b></span>
        </div>

        <div class="logs" style="margin-top:10px">
          <table id="log-table-view">
            <thead>
              <tr>
                <th>เวลา/วันที่</th><th>รหัสพนักงาน</th>
                <th>Material</th><th>Part Number</th><th>Part Name</th><th>Qty.</th>
                <th>Part Number</th><th>Qty.</th><th>Status</th><th>FixedBy</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </main>

    <!-- Placeholders -->
    <main id="view-print" class="wrap" style="display:none">
      <h2>Print Tag</h2>
      <div class="card">พื้นที่นี้เตรียมไว้สำหรับระบบพิมพ์แท็ก</div>
    </main>
    <main id="view-create" class="wrap" style="display:none">
      <h2>Create Tag</h2>
      <div class="card">พื้นที่นี้เตรียมไว้สำหรับสร้าง/ออกแบบแท็ก</div>
    </main>
  </div>

  <!-- Toast -->
  <div id="toast" class="toast" role="status" aria-live="polite"></div>

  <!-- Login Overlay -->
  <div id="login-screen" class="login-screen" aria-modal="true" role="dialog">
    <div class="login-panel">
      <header>เข้าสู่ระบบ</header>
      <div class="body">
        <div class="mutewarn" style="margin-bottom:10px">
          เข้าสู่ระบบด้วยการสแกน Qr-code ที่บัตรพนักงาน (สแกนเนอร์ USB หรือกด “เปิดกล้องสแกนบัตร”)
        </div>
        <div class="row">
          <button id="btn-login-cam" onclick="toggleLoginCamera()">เปิดกล้องสแกนบัตร</button>
          <button id="btn-login-flip" class="icon-btn small" onclick="loginFlipCamera()" style="display:none">สลับกล้อง</button>
        </div>
        <div id="login-cam" style="margin-top:10px; display:none"></div>

        <div class="row" id="login-scan-controls" style="display:none; align-items:center">
          <span class="muted">ล่าสุด:</span>
          <span id="login-last"></span>
          <button id="btn-login-accept" class="icon-btn small" onclick="acceptLoginScan()">ยืนยันอ่าน</button>
          <button class="icon-btn small" onclick="clearLoginPending()">อ่านใหม่</button>
        </div>

        <div class="row" style="margin-top:10px">
          <input id="login-raw" type="text" placeholder="104XXXXXXX หรือ URL ที่มี ?PersonCode=" style="flex:1" />
        </div>
        <div class="row" style="margin-top:10px">
          <span class="badge">รหัสพนักงาน: <b id="emp-id">—</b></span>
        </div>
      </div>
      <div class="foot"><span class="muted">ระบบล็อกอินอัตโนมัติเมื่ออ่านรหัสพนักงานได้</span></div>
    </div>
  </div>

  <!-- QR Overlay (ส่วนกลาง) -->
  <div id="qr-overlay" class="qr-overlay" role="dialog" aria-modal="true">
    <div class="qr-panel">
      <header>สแกน Qr-code — <span id="qr-target-name">—</span></header>
      <div class="qr-body">
        <div id="qr-region"></div>
        <div style="margin-top:8px"><span class="muted">ล่าสุด:</span> <span id="qr-last">—</span></div>
      </div>
      <div class="qr-foot">
        <button class="icon-btn" id="btn-accept" onclick="acceptScan()">ยืนยันอ่าน</button>
        <button class="icon-btn" onclick="resumeScan()">อ่านใหม่</button>
        <div class="spacer"></div>
        <button class="icon-btn" id="btn-flip" onclick="flipScanner()">สลับกล้อง</button>
        <button onclick="closeScanner()">ปิดกล้อง</button>
      </div>
    </div>
  </div>

<script>
/* ===================== MENU / VIEWS ===================== */
function switchView(name){
  for(const id of ['checker','fix','logs','print','create']){
    const main = document.getElementById('view-'+id);
    const btn  = document.getElementById(id==='checker'?'nav-checker':('nav-'+id));
    if(main) main.style.display = (id===name)?'block':'none';
    if(btn)  btn.classList.toggle('active', id===name);
  }
  const parent = document.getElementById('parent-checker');
  if(parent){
    const anyActive = document.getElementById('nav-checker').classList.contains('active')
                   || document.getElementById('nav-fix').classList.contains('active')
                   || document.getElementById('nav-logs').classList.contains('active');
    parent.classList.toggle('active', anyActive);
  }
  if(name==='logs'){ renderLogsView(); }
  if(name==='fix'){ renderFixList(); }
}
function toggleSubmenu(key){
  const sub = document.getElementById('submenu-'+key);
  const parent = document.getElementById('parent-'+key);
  if(!sub||!parent) return;
  sub.classList.toggle('show');
  parent.classList.toggle('expanded');
}
function toggleSidebar(force){
  const layout = document.getElementById('app-layout');
  const want = (typeof force==='boolean') ? force : !layout.classList.contains('collapsed');
  layout.classList.toggle('collapsed', want);
}
document.addEventListener('DOMContentLoaded', ()=>document.getElementById('btn-menu').addEventListener('click', ()=>toggleSidebar()));

/* ========================== STATE ========================== */
let CSV_ROWS = [];
let MAT_COL = null, PN_COL = null, NAME_COL = null;

let PROD = { mat:"", pn:"", name:"", qty:null };
let CUST = { pn:"", qty:null, name:"", mat:"" };

let LOGIN_QR = { inst:null, active:false, cameras:[], idx:0, last:null };
let USER = { code:null };

let SESSION_LOCK = false;
let BUSY = false;
let EXPECT = 'prod';

let FIX_MODE = { active:false, refTs:null }; // โหมดแก้ไข

/* =========== QR Overlay (ส่วนกลาง) =========== */
let SCAN_QR = { inst:null, active:false, cameras:[], idx:0, target:null, lastDecoded:null, paused:false, chainNext:false };
const TARGET_LABEL = { prod:"แท็กผลิต", cust:"แท็กลูกค้า", login:"เข้าสู่ระบบ" };

/* ======================== HELPERS ========================== */
const $_ = id => document.getElementById(id);
const setText = (id, v)=>($_(id).textContent = v);
const norm = s => (s??"").toString().trim();
function sanitizeScan(s){ return (s??"").replace(/[\u200B-\u200D\u2060\uFEFF]/g,'').replace(/[\u0000-\u001F\u007F]/g,'').trim(); }
const toNum = x => { if(x===null||x===undefined||x==="") return null; const n=parseFloat((x+"").replace(/,/g,"")); return Number.isFinite(n)?n:null; };
const normPN = s => norm(s).replace(/\s+/g,"").toUpperCase();
const normPNNoDash = s => normPN(s).replace(/-/g,"");
function cleanMat(s){ const t=norm(s).replace(/\s+/g,""); const n=Number(t); if(Number.isFinite(n)) return String(Math.trunc(n)); const d=t.match(/\d+/g); return d?d.join(""):t; }
function normName(x){ return norm(x).replace(/\s+/g,' ').trim().toUpperCase(); }
function esc(s){ return (s??"").toString().replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }
let toastTimer=null,audioCtx=null;
function ensureAudio(){ if(!audioCtx) audioCtx = new (window.AudioContext||window.webkitAudioContext)(); }
function resumeAudio(){ try{ if(audioCtx && audioCtx.state==='suspended') audioCtx.resume(); }catch{} }

/* ========= กระดิ่งสังเคราะห์ (fallback) ========= */
function synthBell(){
  ensureAudio(); resumeAudio();
  const c = audioCtx, t = c.currentTime;
  const g = c.createGain(); g.gain.setValueAtTime(0.0001, t);
  const o1 = c.createOscillator(); o1.type='sine'; o1.frequency.setValueAtTime(1500, t);
  const o2 = c.createOscillator(); o2.type='sine'; o2.frequency.setValueAtTime(2000, t); o2.detune.setValueAtTime(6, t);
  g.gain.exponentialRampToValueAtTime(0.9, t+0.01);
  g.gain.exponentialRampToValueAtTime(0.0001, t+0.55);
  o1.connect(g); o2.connect(g); g.connect(c.destination);
  o1.start(t); o2.start(t);
  o1.stop(t+0.6); o2.stop(t+0.6);
}

/* ========= ไฟล์เสียง mp3 ========= */
const SOUND_BASE = 'sound/';
let audioOK=null, audioNG=null, audioInvalidProd=null, audioInvalidCust=null, audioInvalidLogin=null, audioBell=null, audioFixOK=null;

function initAudioFiles(){
  try{
    audioOK           = new Audio(SOUND_BASE + 'ok.mp3');
    audioNG           = new Audio(SOUND_BASE + 'ng.mp3');
    audioInvalidProd  = new Audio(SOUND_BASE + 'invalid_prod.mp3');
    audioInvalidCust  = new Audio(SOUND_BASE + 'invalid_cust.mp3');
    audioInvalidLogin = new Audio(SOUND_BASE + 'invalid_login.mp3');
    audioBell         = new Audio(SOUND_BASE + 'bell.mp3');
    audioFixOK        = new Audio(SOUND_BASE + 'ok_fix.mp3'); // เสียง OK แบบพิเศษสำหรับโหมดแก้ไข
    [audioOK, audioNG, audioInvalidProd, audioInvalidCust, audioInvalidLogin, audioBell, audioFixOK].forEach(a=>{
      if(a){ a.preload='auto'; a.crossOrigin='anonymous'; }
    });
  }catch{}
}
function unlockAudio(){
  try{
    [audioOK, audioNG, audioInvalidProd, audioInvalidCust, audioInvalidLogin, audioBell, audioFixOK].forEach(a=>{
      if(!a) return;
      const v=a.volume; a.volume=0;
      const p=a.play();
      if(p && typeof p.then==='function'){
        p.then(()=>{ a.pause(); a.currentTime=0; a.volume=v; }).catch(()=>{ a.volume=v; });
      }else{
        a.pause(); a.currentTime=0; a.volume=v;
      }
    });
  }catch{}
}
async function playMp3WithFallback(audioEl, fallbackFn){
  try{
    if(!audioEl) throw new Error('no audio');
    audioEl.currentTime = 0;
    const p = audioEl.play();
    if(p && typeof p.then==='function'){ await p; }
  }catch{
    try{ if(typeof fallbackFn==='function') fallbackFn(); }catch{}
  }
}
function playOK(){ playMp3WithFallback(FIX_MODE.active? audioFixOK : audioOK, synthBell); }
function playNG(){ playMp3WithFallback(audioNG, synthBell); }
function playInvalidProd(){ playMp3WithFallback(audioInvalidProd, synthBell); }
function playInvalidCust(){ playMp3WithFallback(audioInvalidCust, synthBell); }
function playInvalidLogin(){ playMp3WithFallback(audioInvalidLogin, synthBell); }
function playBell(){ playMp3WithFallback(audioBell, synthBell); }

function showToast(msg, ms=2200){
  const t=$_("toast");
  t.textContent=msg; t.classList.add("show");
  clearTimeout(toastTimer); toastTimer=setTimeout(()=>t.classList.remove("show"),ms);
}
function notify(msg, ms=5000){ playBell(); showToast(msg, ms); }

function formatDateTime(dt){ const p=n=>String(n).padStart(2,'0'); return `${dt.getFullYear()}-${p(dt.getMonth()+1)}-${p(dt.getDate())} ${p(dt.getHours())}:${p(dt.getMinutes())}:${p(dt.getSeconds())}`; }
function updateFocusBanner(){
  const suffix = FIX_MODE.active ? " (โหมดแก้ไข NG)" : "";
  $_("focus-msg").textContent = EXPECT==='prod'
    ? `กรุณาสแกนแท็กฝ่ายผลิต Please scan the Production TAG${suffix}.`
    : `กรุณาสแกนแท็กลูกค้า Please scan the Customer TAG${suffix}.`;
}

/* ========================= CSV (BOM) ========================= */
function loadCSV(){ return new Promise((resolve,reject)=>{ Papa.parse("bom_export.csv",{download:true,header:true,skipEmptyLines:true,complete:res=>resolve(res),error:err=>reject(err)}); }); }
function detectColumns(rows){
  const cols = Object.keys(rows[0]||{});
  MAT_COL  = cols.find(c=>/check[_\s]?material|(^|[^a-z])mat(erial)?([^a-z]|$)|material|code/i.test(c)) || cols[0];
  PN_COL   = cols.find(c=>/customermaterial|part[\s_]?number|^pn$|partno/i.test(c)) || cols[1] || cols[0];
  NAME_COL = cols.find(c=>/customer[_\s]?description|part[\s_]?name|description|desc/i.test(c)) || cols[2] || cols[0];
}

/* ===================== LOOKUPS ===================== */
function mapMatToPart(mat){
  if(!CSV_ROWS.length || !MAT_COL || !PN_COL || !NAME_COL) return {pn:null,name:null};
  const key = cleanMat(mat);
  let hit = CSV_ROWS.find(r => cleanMat(r[MAT_COL]) === key);
  if(!hit){
    const target = Number(key);
    if(Number.isFinite(target)) hit = CSV_ROWS.find(r => Number(cleanMat(r[MAT_COL])) === target);
  }
  return hit ? { pn:norm(hit[PN_COL]), name:norm(hit[NAME_COL]) } : {pn:null, name:null};
}
function mapPnToDetails(pn){
  const target = normPNNoDash(pn);
  if(!CSV_ROWS.length || !PN_COL) return {mat:null, name:null};
  const row = CSV_ROWS.find(r => normPNNoDash(r[PN_COL]||"") === target);
  if(!row) return {mat:null, name:null};
  return { mat: norm(row[MAT_COL]||""), name: norm(row[NAME_COL]||"") };
}

/* ===================== TAG CLASSIFIER ===================== */
function isLikelyProd(raw){
  const s = norm(raw); const parts = s.split("|");
  if(parts.length!==2) return false;
  const mat = parts[0].trim(), qty = parts[1].trim();
  return /^[A-Za-z0-9._-]{3,}$/.test(mat) && /^\d+(\.\d+)?$/.test(qty);
}
function isLikelyCust(raw){
  const s = norm(raw);
  const t = s.split("|");
  if(t.length < 3) return false;
  const pnBase = (t[1]||"").trim();
  const pnSfx  = (t[2]||"").trim();
  const qty3   = (t[3]||"").trim();
  const qty4   = (t[4]||"").trim();
  const pnCandidate = pnBase + pnSfx;
  const pnLooksOk = /[A-Za-z]/.test(pnCandidate) && /^[A-Za-z0-9-]{3,}$/.test(pnCandidate);
  const hasQty = (/^\d+(\.\d+)?$/.test(qty3)) || (/^\d+(\.\d+)?$/.test(qty4));
  return pnLooksOk && hasQty;
}
function classifyTag(raw){
  const p = isLikelyProd(raw);
  const c = isLikelyCust(raw);
  if(p && !c) return 'prod';
  if(c && !p) return 'cust';
  return 'unknown';
}

/* ========================= UI LOCK ========================= */
function enforceExpectUI(){
  const prodOK = EXPECT==='prod';
  const prodIn = $_("in-prod"), custIn = $_("in-cust");
  prodIn.readOnly = !prodOK;  custIn.readOnly = prodOK;
  if(prodOK){ prodIn.focus(); } else { custIn.focus(); }
  updateFocusBanner();
}

/* ========================= SESSION RESET ========================= */
function hardReset(){
  $_("in-prod").value = ""; $_("in-cust").value = "";
  PROD = {mat:"",pn:"",name:"",qty:null}; CUST={pn:"",qty:null,name:"",mat:""};
  $_("banner").style.display="none";
  for(const id of ["cmp-pn","cmp-qty","cmp-name","cmp-mat"]){ $_(id).classList.remove("ok-row","ng-row"); }
  for(const id of ["cmp-pn-prod","cmp-pn-cust","cmp-name-prod","cmp-name-cust","cmp-qty-prod","cmp-qty-cust","cmp-mat-prod","cmp-mat-cust"]){ setText(id,"—"); }
  SESSION_LOCK=false; EXPECT='prod'; enforceExpectUI();
}
function maybeResetBeforeProdScan(){ if(SESSION_LOCK) hardReset(); }

/* ========================= PARSERS ========================= */
function parseProduction(){
  if(BUSY) return;
  if(!USER.code){ notify("กรุณาเข้าสู่ระบบก่อนใช้งาน"); return; }
  if(EXPECT!=='prod'){ notify("ต้องสแกน ‘แท็กผลิต’ ก่อน"); enforceExpectUI(); return; }
  maybeResetBeforeProdScan();

  const raw = $_("in-prod").value.trim();
  const type = classifyTag(raw);
  if(type!=='prod'){
    playInvalidProd();
    $_("in-prod").value="";
    notify("Qr code ไม่ถูกต้อง กรุณาสแกน Qr code ที่แท็กฝ่ายผลิต หรือตรวจสอบภาษาของคีย์บอร์ดให้เป็นภาษาอังกฤษ");
    enforceExpectUI();
    return;
  }

  BUSY=true;
  const [mat, qty] = raw.split("|");
  PROD.mat = norm(mat||""); 
  PROD.qty = toNum(qty||"");
  const m = mapMatToPart(PROD.mat); 
  PROD.pn=m.pn||""; 
  PROD.name=m.name||"";

  setText("cmp-pn-prod",  PROD.pn || "—");
  setText("cmp-name-prod",PROD.name || "—");
  setText("cmp-qty-prod", PROD.qty ?? "—");
  setText("cmp-mat-prod", PROD.mat || "—");

  EXPECT='cust'; 
  enforceExpectUI();
  BUSY=false;
}

function parseCustomer(){
  if(BUSY) return;
  if(!USER.code){ notify("กรุณาเข้าสู่ระบบก่อนใช้งาน"); return; }
  if(EXPECT!=='cust'){ notify("ต้องสแกน ‘แท็กลูกค้า’ ถัดจากแท็กผลิต"); enforceExpectUI(); return; }

  const raw = $_("in-cust").value.trim();
  const type = classifyTag(raw);
  if(type!=='cust'){
    playInvalidCust();
    $_("in-cust").value="";
    notify("Qr code ไม่ถูกต้อง กรุณาสแกน Qr code ที่แท็กลูกค้า หรือตรวจสอบภาษาของคีย์บอร์ดให้เป็นภาษาอังกฤษ");
    enforceExpectUI();
    return;
  }

  BUSY=true;
  const t = raw.split("|");
  const base = (t[1]||"").trim(); 
  const sfx  = (t[2]||"").trim();
  const qty  = (t[4]||"").trim() || (t[3]||"").trim();
  CUST.pn  = norm(base + sfx); 
  CUST.qty = toNum(qty);

  const det = mapPnToDetails(CUST.pn);
  CUST.name = det.name || ""; 
  CUST.mat  = det.mat  || "";

  setText("cmp-pn-cust",  CUST.pn  || "—");
  setText("cmp-name-cust",CUST.name|| "—");
  setText("cmp-qty-cust", CUST.qty ?? "—");
  setText("cmp-mat-cust", CUST.mat || "—");

  compareNow(); 
  BUSY=false;
}

/* ========================= COMPARE & RESULT ========================= */
function showBanner(ok){ const b=$_("banner"); b.className="result-banner "+(ok?"banner-ok":"banner-ng"); b.textContent=ok?"OK":"NG"; b.style.display="flex"; }
function prepNextCycleAfterCompare(){ $_("in-prod").value=""; $_("in-cust").value=""; EXPECT='prod'; enforceExpectUI(); }
async function compareNow(){
  const pnOk   = (!!PROD.pn && !!CUST.pn) && (normPN(PROD.pn)===normPN(CUST.pn) || normPNNoDash(PROD.pn)===normPNNoDash(CUST.pn));
  const qtyOk  = toNum(PROD.qty)!=null && toNum(CUST.qty)!=null && toNum(PROD.qty)===toNum(CUST.qty);
  const nameOk = !!PROD.name && !!CUST.name && (normName(PROD.name)===normName(CUST.name));
  const matOk  = !!PROD.mat  && !!CUST.mat  && (cleanMat(PROD.mat)===cleanMat(CUST.mat));
  const ok = pnOk && qtyOk;

  showBanner(ok); if(ok) playOK(); else playNG();

  for(const id of ["cmp-pn","cmp-qty","cmp-name","cmp-mat"]){ const tr=$_(id); tr.classList.remove("ok-row","ng-row"); }
  $_("cmp-pn").classList.add(pnOk? "ok-row" : "ng-row");
  $_("cmp-qty").classList.add(qtyOk? "ok-row" : "ng-row");
  $_("cmp-name").classList.add(nameOk? "ok-row" : "ng-row");
  $_("cmp-mat").classList.add(matOk? "ok-row" : "ng-row");

  await saveLog(ok);

  // ถ้าเป็นโหมดแก้ไข: ok = เพิ่ม log FIXED และกลับไปลิสต์
  if(FIX_MODE.active){
    if(ok){
      await saveFixLog(FIX_MODE.refTs);
      FIX_MODE={active:false,refTs:null};
      notify("การแก้ไขเสร็จสมบูรณ์");
      switchView('fix');
    }else{
      notify("แก้ไขยังไม่สำเร็จ: กรุณาตรวจสอบอีกครั้ง");
    }
  }

  prepNextCycleAfterCompare();
  SESSION_LOCK = true;
}

/* ==================== LOGS ==================== */
function summarizeLogs(list){
  const total = list.length;
  let ok=0, ng=0;
  for(const r of list){
    const s = (r.result||"").toUpperCase();
    if(s==="OK") ok++;
    else if(s==="NG") ng++;
  }
  return {total, ok, ng};
}
async function renderLogsView(){
  try{
    const listAll = await getAllLogs();
    const list = filterLogs(listAll);
    const tb = $_("log-table-view").querySelector("tbody");
    tb.innerHTML="";
    for(const r of list){
      const s = (r.result||"").toUpperCase();
      const cls = s==="OK" ? "ok-row" : (s==="NG" ? "ng-row" : "fix-row");
      tb.insertAdjacentHTML("beforeend", `<tr class="${cls}">
        <td>${esc(r.ts||"")}</td><td>${esc(r.emp||"")}</td>
        <td>${esc(r.mat||"")}</td><td>${esc(r.prodPN||"")}</td><td>${esc(r.name||"")}</td><td>${esc(r.prodQty??"")}</td>
        <td>${esc(r.custPN||"")}</td><td>${esc(r.custQty??"")}</td><td>${esc(r.result||"")}</td><td>${esc(r.fixedBy||"")}</td>
      </tr>`);
    }
    const {total, ok, ng} = summarizeLogs(list.filter(r=>r.result!=="FIXED"));
    $_("sum-total").textContent = total;
    $_("sum-ok").textContent = ok;
    $_("sum-ng").textContent = ng;
  }catch(e){ console.error(e); notify("อ่านข้อมูล Logs ไม่สำเร็จ"); }
}
function filterLogs(list){
  const s = ($_("flt-start").value||"").trim();
  const e = ($_("flt-end").value||"").trim();
  return (list||[]).filter(r=>{
    const dt = (r.ts||"").slice(0,10);
    if(s && dt && dt < s) return false;
    if(e && dt && dt > e) return false;
    return true;
  });
}
function applyFilters(){ renderLogsView(); }
function clearFilters(){ $_("flt-start").value=""; $_("flt-end").value=""; renderLogsView(); }

/* ====================== LOGS: IndexedDB ====================== */
const DB_NAME="prd-logs", STORE="scanLogs";
let DB = null;
function ensureDB(){
  if(DB) return Promise.resolve();
  return new Promise((resolve, reject)=>{
    const req = indexedDB.open(DB_NAME, 1);
    req.onupgradeneeded = () => {
      const db = req.result;
      if(!db.objectStoreNames.contains(STORE)){
        db.createObjectStore(STORE, {autoIncrement:true});
      }
    };
    req.onsuccess = () => { DB=req.result; DB.onversionchange = ()=>{ try{ DB.close(); }catch{} }; resolve(); };
    req.onerror = () => reject(req.error);
  });
}
function addLog(row){
  return ensureDB().then(()=>new Promise((resolve, reject)=>{
    const tx = DB.transaction(STORE, "readwrite", {durability:"strict"});
    tx.objectStore(STORE).add(row);
    tx.oncomplete = ()=>resolve();
    tx.onerror = ()=>reject(tx.error);
  }));
}
function getAllLogs(){
  return ensureDB().then(()=>new Promise((resolve, reject)=>{
    const tx = DB.transaction(STORE, "readonly");
    const rq = tx.objectStore(STORE).getAll();
    rq.onsuccess = ()=>resolve(rq.result||[]);
    rq.onerror = ()=>reject(rq.error);
  }));
}
function clearAllLogs(){
  return ensureDB().then(()=>new Promise((resolve, reject)=>{
    const tx = DB.transaction(STORE, "readwrite");
    tx.objectStore(STORE).clear();
    tx.oncomplete=()=>resolve();
    tx.onerror=()=>reject(tx.error);
  }));
}
function csvEscape(v){ const s=(v??"").toString().replace(/"/g,'""'); return /[",\n]/.test(s)?`"${s}"`:s; }
async function saveLog(ok){
  const now = new Date();
  const rowObj = {
    ts: formatDateTime(now),
    emp: USER.code || "",
    mat: PROD.mat,
    prodPN: PROD.pn,
    name: PROD.name,
    prodQty: PROD.qty,
    custPN: CUST.pn,
    custQty: CUST.qty,
    result: ok ? "OK" : "NG"
  };
  try{ await addLog(rowObj); }catch(e){ console.error(e); notify("บันทึกลง IndexedDB ไม่สำเร็จ"); }
}
async function saveFixLog(refTs){
  const now = new Date();
  const rowObj = {
    ts: formatDateTime(now),
    emp: USER.code || "",
    mat: PROD.mat,
    prodPN: PROD.pn, name: PROD.name, prodQty: PROD.qty,
    custPN: CUST.pn, custQty: CUST.qty,
    result: "FIXED", refTs, fixedBy: USER.code || ""
  };
  try{ await addLog(rowObj); }catch(e){ console.error(e); notify("บันทึกสถานะแก้ไขไม่สำเร็จ"); }
}
async function exportFilteredLogs(){
  const rows = filterLogs(await getAllLogs());
  const header = ["timestamp","employee_code","material","prod_part_number","part_name","prod_qty","cust_part_number","cust_qty","status","fixedBy","refTs"];
  const lines = [header.join(",")];
  for(const r of rows){
    const vals = [r.ts,r.emp,r.mat,r.prodPN,r.name,r.prodQty,r.custPN,r.custQty,r.result,r.fixedBy||"",r.refTs||""].map(csvEscape);
    lines.push(vals.join(","));
  }
  const blob = new Blob([`\ufeff${lines.join("\n")}`], {type:"text/csv;charset=utf-8"});
  const url = URL.createObjectURL(blob); const a=document.createElement("a");
  a.href=url; a.download=`logs_filtered_${new Date().toISOString().slice(0,19).replace(/[:T]/g,'-')}.csv`;
  document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
}
async function handleClearLogs(){
  const pass = ($_("admin-pass").value||"").trim();
  if(pass!=="adminpe"){ notify("รหัสผ่านไม่ถูกต้อง"); return; }
  try{ await clearAllLogs(); $_("admin-pass").value=""; renderLogsView(); notify("ล้าง Logs ทั้งหมดแล้ว"); }
  catch(e){ console.error(e); notify("ล้าง Logs ไม่สำเร็จ"); }
}

/* ==================== FIX LIST ==================== */
async function renderFixList(){
  const all = await getAllLogs();
  // งาน NG ที่ยังไม่ถูกอ้างอิงด้วย FIXED
  const fixedRefs = new Set(all.filter(r=>r.result==="FIXED").map(r=>r.refTs));
  const todo = all.filter(r=>r.result==="NG" && !fixedRefs.has(r.ts));
  const done = all.filter(r=>r.result==="FIXED");

  $_('fix-todo').textContent = todo.length;
  $_('fix-done').textContent = done.length;

  const tb = $_('fix-table').querySelector('tbody');
  tb.innerHTML = '';
  for(const r of todo){
    tb.insertAdjacentHTML('beforeend', `<tr class="ng-row">
      <td>${esc(r.ts||"")}</td><td>${esc(r.emp||"")}</td>
      <td>${esc(r.mat||"")}</td><td>${esc(r.prodPN||"")}</td><td>${esc(r.name||"")}</td><td>${esc(r.prodQty??"")}</td>
      <td>${esc(r.custPN||"")}</td><td>${esc(r.custQty??"")}</td>
      <td><button class="icon-btn small" onclick="startFix('${r.ts}')">แก้ไข</button></td>
    </tr>`);
  }
}
function startFix(refTs){
  FIX_MODE = {active:true, refTs};
  $_('fix-banner').style.display='block';
  $_('fix-ref').textContent = refTs;
  switchView('checker');
  hardReset();
  openScanner('prod', {chainNext:true}); // เริ่มสแกนผลิต แล้วต่อด้วยลูกค้าอัตโนมัติ
}
function cancelFixMode(){
  FIX_MODE = {active:false, refTs:null};
  $_('fix-banner').style.display='none';
  switchView('fix');
}

/* =========================== BOOT ========================== */
(async function boot(){
  await ensureDB();
  initAudioFiles();
  switchView('checker');
  try{ const res=await loadCSV(); CSV_ROWS=res.data||[]; if(!CSV_ROWS.length) throw new Error("CSV ว่าง"); detectColumns(CSV_ROWS); }
  catch(e){ console.error(e); }
  hookKeyboard();
  enforceExpectUI();
  $_("login-raw").focus();
  toggleSidebar(true);
})();

/* ==================== KEYBOARD / SCANNER ==================== */
function hookKeyboard(){
  const prodIn=$_("in-prod"), custIn=$_("in-cust");
  prodIn.addEventListener("keydown", e=>{
    if(EXPECT!=='prod'){ e.preventDefault(); notify("ตอนนี้ต้องสแกน ‘แท็กลูกค้า’"); enforceExpectUI(); return; }
    if(e.key!=="Enter" && SESSION_LOCK){ maybeResetBeforeProdScan(); }
    if(e.key==="Enter"){ e.preventDefault(); /* ปิดใช้ Enter: ต้องกดยืนยันหน้ากล้องเท่านั้น */ }
  });
  custIn.addEventListener("keydown", e=>{
    if(EXPECT!=='cust'){ e.preventDefault(); notify("กรุณาสแกน ‘แท็กผลิต’ ก่อน"); enforceExpectUI(); return; }
    if(e.key==="Enter"){ e.preventDefault(); /* ปิดใช้ Enter */ }
  });

  // login field
  const loginInput = $_('login-raw');
  let loginDeb=null;
  loginInput.addEventListener('input', ()=>{
    clearTimeout(loginDeb);
    loginDeb=setTimeout(()=>{
      tryAutoLoginFromRaw(loginInput.value);
    }, 50);
  });
  loginInput.addEventListener('keydown', e=>{
    if(e.key==='Enter'){ e.preventDefault(); tryAutoLoginFromRaw(loginInput.value, true); }
  });

  document.body.addEventListener('click', ()=>{ ensureAudio(); unlockAudio(); }, {once:true});
}

/* ====================== LOGIN ====================== */
function parseEmployeePayload(raw){
  const out={code:""};
  if(!raw) return out;
  const s = sanitizeScan(raw);
  try{ const u=new URL(s.startsWith("http")?s:("https://dummy.local/?"+s)); const pc=u.searchParams.get("PersonCode")||u.searchParams.get("personcode"); if(pc){ out.code=sanitizeScan(pc); return out; } }catch{}
  try{ const o=JSON.parse(s); out.code=sanitizeScan(o.PersonCode||o.personcode||o.id||o.empid||o.code||""); if(out.code) return out; }catch{}
  if(/[?&=]/.test(s)){ const qs=s.includes("?")?s.split("?")[1]:s; const p=new URLSearchParams(qs); const v=p.get("PersonCode")||p.get("personcode")||p.get("id")||p.get("empid")||p.get("code")||""; if(v){ out.code=sanitizeScan(v); return out; } }
  if(/[=:].+/.test(s)){ for(const p of s.split(/[;|,\n]/)){ const [k0,...v]=p.split(/[=:]/); const k=(k0||"").trim().toLowerCase(); const vv=sanitizeScan(v.join(":")); if(["personcode","id","empid","employeeid","รหัส","รหัสพนักงาน","code"].includes(k)) { out.code=out.code||vv; } } if(out.code) return out; }
  const m=s.match(/(PersonCode|รหัสพนักงาน|รหัส|code)\s*[:：]?\s*([A-Za-z0-9\-_]+)/i); if(m){ out.code=sanitizeScan(m[2]); return out; }
  if(/^[A-Za-z0-9\-_]{5,}$/.test(s)){ out.code=s; return out; }
  return out;
}
function tryAutoLoginFromRaw(val, force=false){
  const emp=parseEmployeePayload(val);
  fillEmployeeUI(emp);
  if(emp.code && (force || /^[A-Za-z0-9\-_]{5,}$/.test(emp.code))){
    confirmLogin(true);
    return;
  }
  if(force){
    playInvalidLogin();
    notify("ไม่พบรหัสพนักงานใน Qr-code / รูปแบบไม่ถูกต้อง");
  }
}
function isFrontCam(cam){ return /front|user|face|自拍|內建|built.?in/i.test(cam?.label||""); }
function applyLoginMirror(){
  const cam = LOGIN_QR.cameras[LOGIN_QR.idx];
  const mirror = isFrontCam(cam);
  $_('login-cam').classList.toggle('mirror', !!mirror);
}
async function toggleLoginCamera(){
  try{
    const camDiv=$_('login-cam'), btn=$_('btn-login-cam'), flip=$_('btn-login-flip');
    if(LOGIN_QR.active){ 
      try{ await LOGIN_QR.inst.stop(); }catch{}
      camDiv.style.display="none"; btn.textContent="เปิดกล้องสแกนบัตร"; flip.style.display="none";
      LOGIN_QR.active=false; return; 
    }
    camDiv.style.display="block"; btn.textContent="ปิดกล้องสแกนบัตร";
    if(!LOGIN_QR.inst) LOGIN_QR.inst=new Html5Qrcode(camDiv.id);
    const cams=await Html5Qrcode.getCameras(); 
    if(!cams?.length){ camDiv.textContent="ไม่พบกล้อง"; return; }
    LOGIN_QR.cameras=cams; 
    // เริ่มที่กล้องหลัง (ถ้ามี) ไม่งั้นตัวแรก
    const env = cams.find(c=>/back|rear|environment/i.test(c.label));
    LOGIN_QR.idx = env ? cams.indexOf(env) : 0;

    const startCam = async (idx)=>{
      await LOGIN_QR.inst.start(cams[idx].id,{fps:10,qrbox:250}, onLoginScan);
      LOGIN_QR.idx = idx;
    };
    try{ await startCam(LOGIN_QR.idx); }
    catch{ // ลองตัวอื่น (เช่น กล้องหน้า)
      const alt = (LOGIN_QR.idx+1) % cams.length;
      await startCam(alt);
    }

    LOGIN_QR.active=true;
    flip.style.display = "inline-flex";
    flip.disabled = cams.length<=1;
    applyLoginMirror();

    $_('login-scan-controls').style.display='flex';
    $_('login-last').textContent='—';
    LOGIN_QR.last=null;
  }catch(err){ $_('login-cam').textContent="เปิดกล้องไม่ได้: "+(err?.message||err); }
}
async function loginFlipCamera(){
  if(!LOGIN_QR.active || !LOGIN_QR.cameras.length) return;
  try{
    const next = (LOGIN_QR.idx + 1) % LOGIN_QR.cameras.length;
    await LOGIN_QR.inst.stop();
    await LOGIN_QR.inst.start(LOGIN_QR.cameras[next].id,{fps:10,qrbox:250}, onLoginScan);
    LOGIN_QR.idx = next;
    applyLoginMirror();
  }catch(err){ $_('login-cam').textContent="สลับกล้องไม่ได้: "+(err?.message||err); }
}
function onLoginScan(txt){
  const clean = sanitizeScan(txt);
  LOGIN_QR.last = clean;
  $_('login-last').textContent = clean;
}
function acceptLoginScan(){
  if(!LOGIN_QR.last){ notify("ยังไม่พบข้อมูลจากกล้อง"); return; }
  $_('login-raw').value = LOGIN_QR.last;
  tryAutoLoginFromRaw(LOGIN_QR.last, true);
}
function clearLoginPending(){ LOGIN_QR.last=null; $_('login-last').textContent='—'; }
function fillEmployeeUI(emp){ $_('emp-id').textContent=emp.code||'—'; }
function confirmLogin(auto=false){
  const code=$_('emp-id').textContent.trim(); 
  if(!code||code==='—'){ if(!auto) notify("ยังไม่ได้อ่านรหัสพนักงานจากบัตร"); return; }
  USER={code};
  try{ if(LOGIN_QR.active&&LOGIN_QR.inst){ LOGIN_QR.inst.stop(); LOGIN_QR.active=false; $_('btn-login-flip').style.display="none"; } }catch{}
  document.getElementById("login-screen").style.display="none";
  document.getElementById("view-checker").removeAttribute("aria-hidden");
  setText("user-pill",`รหัสพนักงาน: ${USER.code}`); $_("user-pill").style.display="inline-block"; $_("btn-logout").style.display="inline-block";
  enableUI(true); notify(`เข้าสู่ระบบสำเร็จ: ${USER.code}`, 3000);
  EXPECT='prod'; enforceExpectUI();
}
async function logout(){
  try{ if(LOGIN_QR.active && LOGIN_QR.inst) await LOGIN_QR.inst.stop(); }catch{}
  USER={code:null}; enableUI(false); $_("user-pill").style.display="none"; $_("btn-logout").style.display="none";
  hardReset(); $_("login-screen").style.display="flex"; document.getElementById("view-checker").setAttribute("aria-hidden","true");
  $_("login-raw").value=""; $_("emp-id").textContent="—"; $_("login-raw").focus();
}
function enableUI(on){
  $_("in-prod").readOnly = !on; $_("in-cust").readOnly = !on;
  if(on) enforceExpectUI();
}

/* ==================== QR OVERLAY ส่วนกลาง ==================== */
async function openScanner(target, opts={}){
  SCAN_QR.target = target;
  SCAN_QR.chainNext = !!opts.chainNext && target==='prod'; // เฉพาะแรกให้ต่อไปลูกค้า
  SCAN_QR.lastDecoded = null;
  SCAN_QR.paused = false;
  $_('qr-target-name').textContent = TARGET_LABEL[target] || '—';
  $_('qr-last').textContent = '—';
  $_('qr-overlay').style.display = 'flex';

  if(!SCAN_QR.inst) SCAN_QR.inst = new Html5Qrcode('qr-region');

  try{
    const cams = await Html5Qrcode.getCameras();
    if(!cams?.length){ $_('qr-region').textContent="ไม่พบกล้อง"; return; }
    SCAN_QR.cameras = cams; 
    const env = cams.find(c=>/back|rear|environment/i.test(c.label));
    let idx = env ? cams.indexOf(env) : 0;

    const startIdx = async (i)=>{
      await SCAN_QR.inst.start(cams[i].id, {fps:10, qrbox:250}, onOverlayScan);
      SCAN_QR.idx = i;
    };
    try{ await startIdx(idx); }
    catch{
      const alt = (idx+1)%cams.length;
      await startIdx(alt);
    }

    SCAN_QR.active = true;
    $_('btn-flip').disabled = cams.length<=1;
  }catch(err){
    $_('qr-region').textContent = "เปิดกล้องไม่ได้: " + (err?.message || err);
  }
}
function onOverlayScan(decodedText){
  if(SCAN_QR.paused) return;
  const clean = sanitizeScan(decodedText);
  SCAN_QR.lastDecoded = clean;
  $_('qr-last').textContent = clean;
}
function resumeScan(){ SCAN_QR.paused=false; SCAN_QR.lastDecoded=null; $_('qr-last').textContent='—'; }
async function acceptScan(){
  if(!SCAN_QR.lastDecoded){ notify("ยังไม่พบข้อมูลจากกล้อง"); return; }
  const text = SCAN_QR.lastDecoded;
  SCAN_QR.paused=true;
  await closeScanner();
  if(SCAN_QR.target==='prod'){
    $_('in-prod').value = text; parseProduction();
    if(SCAN_QR.chainNext){ openScanner('cust'); }
  }else if(SCAN_QR.target==='cust'){
    $_('in-cust').value = text; parseCustomer();
  }else if(SCAN_QR.target==='login'){
    $_('login-raw').value = text; tryAutoLoginFromRaw(text, true);
  }
}
async function flipScanner(){
  if(!SCAN_QR.active || !SCAN_QR.cameras.length) return;
  try{
    const next = (SCAN_QR.idx + 1) % SCAN_QR.cameras.length;
    await SCAN_QR.inst.stop();
    await SCAN_QR.inst.start(SCAN_QR.cameras[next].id, {fps:10, qrbox:250}, onOverlayScan);
    SCAN_QR.idx = next;
  }catch(err){
    notify("สลับกล้องไม่ได้: "+(err?.message||err));
  }
}
async function closeScanner(){
  try{ if(SCAN_QR.active && SCAN_QR.inst){ await SCAN_QR.inst.stop(); } }catch{}
  SCAN_QR.active=false;
  $_('qr-overlay').style.display='none';
}
</script>
</body>
</html>
